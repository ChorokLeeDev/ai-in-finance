"""
aggregate í•¨ìˆ˜ì˜ í•µì‹¬ ì—°ì‚° ì´í•´í•˜ê¸°
out[dst] += x[src] * deg_inv[dst]ë¥¼ ì™„ì „íˆ íŒŒí—¤ì¹˜ê¸°
"""

import torch

print("=" * 80)
print("ğŸ” aggregate í•¨ìˆ˜ì˜ í•µì‹¬ ì—°ì‚° ì´í•´í•˜ê¸°")
print("=" * 80)

# ============================================================================
# ì˜ˆì‹œ 1: ê°€ì¥ ë‹¨ìˆœí•œ ê²½ìš° (1ê°œ ì—£ì§€)
# ============================================================================
print("\nğŸ“Œ ì˜ˆì‹œ 1: ê°€ì¥ ë‹¨ìˆœí•œ ê²½ìš° (ë…¸ë“œ 0 â†’ ë…¸ë“œ 1)")
print("-" * 80)

# 3ê°œ ë…¸ë“œ, ê° ë…¸ë“œëŠ” 2ì°¨ì› íŠ¹ì„±
x = torch.tensor([
    [0.9, 0.1],  # ë…¸ë“œ 0: AI ë…¼ë¬¸
    [0.5, 0.5],  # ë…¸ë“œ 1: ì¤‘ê°„
    [0.1, 0.9],  # ë…¸ë“œ 2: ìƒë¬¼ ë…¼ë¬¸
], dtype=torch.float)

# ì—£ì§€: 0 â†’ 1 (í•œ ê°œë§Œ!)
row = torch.tensor([0])  # ì¶œë°œ
col = torch.tensor([1])  # ë„ì°©

print(f"\nì´ˆê¸° ë…¸ë“œ íŠ¹ì„±:")
print(f"  ë…¸ë“œ 0: {x[0].tolist()}")
print(f"  ë…¸ë“œ 1: {x[1].tolist()}")
print(f"  ë…¸ë“œ 2: {x[2].tolist()}")

print(f"\nì—£ì§€: ë…¸ë“œ {row[0].item()} â†’ ë…¸ë“œ {col[0].item()}")

# deg_inv ê³„ì‚° (ê°„ë‹¨íˆ í•˜ê¸° ìœ„í•´ ì§ì ‘ ì„¤ì •)
deg_inv = torch.tensor([1.0, 1.0, 1.0])  # ê° ë…¸ë“œì˜ ì´ì›ƒ ìˆ˜ ì—­ìˆ˜

# Step 1: ë¹ˆ out í…ì„œ ìƒì„±
out = torch.zeros_like(x)
print(f"\nStep 1: out ì´ˆê¸°í™” (ëª¨ë‘ 0)")
print(f"  out[0]: {out[0].tolist()}")
print(f"  out[1]: {out[1].tolist()}")
print(f"  out[2]: {out[2].tolist()}")

# Step 2: ì—£ì§€ë³„ë¡œ ë©”ì‹œì§€ ì „ë‹¬
for i, (src, dst) in enumerate(zip(row, col)):
    print(f"\nStep 2: ì—£ì§€ ì²˜ë¦¬ (ë…¸ë“œ {src} â†’ ë…¸ë“œ {dst})")

    print(f"\n  ì—°ì‚°: out[{dst}] += x[{src}] * deg_inv[{dst}]")
    print(f"       out[{dst}] += {x[src].tolist()} * {deg_inv[dst].item()}")

    result = x[src] * deg_inv[dst]
    print(f"       ê³„ì‚° ê²°ê³¼: {result.tolist()}")

    out[dst] += result
    print(f"       out[{dst}] (ì—…ë°ì´íŠ¸ í›„): {out[dst].tolist()}")

print(f"\nStep 3: ìµœì¢… ê²°ê³¼")
print(f"  out[0]: {out[0].tolist()} â† ë©”ì‹œì§€ ì—†ìŒ")
print(f"  out[1]: {out[1].tolist()} â† ë…¸ë“œ 0ì˜ ì •ë³´ ë°›ìŒ!")
print(f"  out[2]: {out[2].tolist()} â† ë©”ì‹œì§€ ì—†ìŒ")

print(f"\nğŸ’¡ í•´ì„:")
print(f"  ë…¸ë“œ 1ì€ ë…¸ë“œ 0ì˜ íŠ¹ì„± {x[0].tolist()}ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.")
print(f"  ì›ë˜ëŠ” {x[1].tolist()}ì˜€ì§€ë§Œ, ì´ì œ {out[1].tolist()}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.")

# ============================================================================
# ì˜ˆì‹œ 2: ì—¬ëŸ¬ ì´ì›ƒì´ ìˆëŠ” ê²½ìš° (í‰ê·  ê³„ì‚°)
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ“Œ ì˜ˆì‹œ 2: ì—¬ëŸ¬ ì´ì›ƒì´ ìˆëŠ” ê²½ìš° (í‰ê·  ê³„ì‚°)")
print("-" * 80)

# ë™ì¼í•œ x ì‚¬ìš©
x = torch.tensor([
    [1.0, 0.0],  # ë…¸ë“œ 0: ìˆœìˆ˜ AI
    [0.0, 1.0],  # ë…¸ë“œ 1: ìˆœìˆ˜ ìƒë¬¼
    [0.8, 0.2],  # ë…¸ë“œ 2: AI ì„±í–¥
    [0.5, 0.5],  # ë…¸ë“œ 3: ì¤‘ê°„ (ì—…ë°ì´íŠ¸ë  ì˜ˆì •)
], dtype=torch.float)

# ì—£ì§€: 0â†’3, 1â†’3, 2â†’3 (ëª¨ë‘ ë…¸ë“œ 3ìœ¼ë¡œ!)
row = torch.tensor([0, 1, 2])  # ì¶œë°œ
col = torch.tensor([3, 3, 3])  # ë„ì°© (ëª¨ë‘ 3)

print(f"\nì´ˆê¸° ë…¸ë“œ íŠ¹ì„±:")
for i in range(4):
    print(f"  ë…¸ë“œ {i}: {x[i].tolist()}")

print(f"\nì—£ì§€:")
for src, dst in zip(row, col):
    print(f"  ë…¸ë“œ {src} â†’ ë…¸ë“œ {dst}")

# deg_inv ê³„ì‚°
# ë…¸ë“œ 3ì€ 3ê°œì˜ ì´ì›ƒì„ ê°€ì§€ë¯€ë¡œ deg_inv[3] = 1/3
deg = torch.bincount(row, minlength=x.size(0)).float()
deg_inv = 1.0 / deg
deg_inv[deg_inv == float('inf')] = 0

print(f"\në…¸ë“œë³„ ì´ì›ƒ ìˆ˜ì™€ ì—­ìˆ˜:")
for i in range(4):
    if deg[i] > 0:
        print(f"  ë…¸ë“œ {i}: ì´ì›ƒ {int(deg[i])}ê°œ â†’ deg_inv = {deg_inv[i]:.4f}")

# Step 1: ë¹ˆ out í…ì„œ
out = torch.zeros_like(x)
print(f"\nStep 1: out ì´ˆê¸°í™”")
for i in range(4):
    print(f"  out[{i}]: {out[i].tolist()}")

# Step 2: ì—£ì§€ë³„ë¡œ ì²˜ë¦¬
print(f"\nStep 2: ì—£ì§€ë³„ ë©”ì‹œì§€ ì „ë‹¬")
for idx, (src, dst) in enumerate(zip(row, col)):
    print(f"\n  [{idx+1}] ì—£ì§€ {src}â†’{dst} ì²˜ë¦¬:")
    print(f"      ì—°ì‚°: out[{dst}] += x[{src}] * deg_inv[{dst}]")
    print(f"           out[{dst}] += {x[src].tolist()} * {deg_inv[dst]:.4f}")

    before = out[dst].clone()
    out[dst] += x[src] * deg_inv[dst]

    print(f"      ì´ì „: {before.tolist()}")
    print(f"      ì´í›„: {out[dst].tolist()}")

print(f"\nStep 3: ìµœì¢… ê²°ê³¼")
for i in range(4):
    print(f"  out[{i}]: {out[i].tolist()}")

print(f"\nğŸ’¡ ë¶„ì„:")
print(f"  ë…¸ë“œ 3ì˜ ìµœì¢… ê°’: {out[3].tolist()}")
print(f"\n  ì´ê²ƒì€ 3ê°œ ì´ì›ƒì˜ í‰ê· ì…ë‹ˆë‹¤:")
print(f"    í‰ê·  = (ë…¸ë“œ0 + ë…¸ë“œ1 + ë…¸ë“œ2) / 3")
print(f"         = ({x[0].tolist()} + {x[1].tolist()} + {x[2].tolist()}) / 3")

manual_avg = (x[0] + x[1] + x[2]) / 3
print(f"         = {manual_avg.tolist()}")
print(f"\n  ì‹¤ì œ out[3]: {out[3].tolist()}")
print(f"  ì¼ì¹˜ ì—¬ë¶€: {torch.allclose(out[3], manual_avg)}")

# ============================================================================
# ì˜ˆì‹œ 3: += ì—°ì‚°ì˜ ì¤‘ìš”ì„±
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ“Œ ì˜ˆì‹œ 3: += ì—°ì‚°ì˜ ì¤‘ìš”ì„± (ëˆ„ì ì´ í•„ìš”í•œ ì´ìœ )")
print("-" * 80)

print("\në§Œì•½ += ëŒ€ì‹  = ë¥¼ ì“´ë‹¤ë©´?")
print("-" * 80)

# ë™ì¼í•œ ì„¤ì •
out_wrong = torch.zeros_like(x)
out_correct = torch.zeros_like(x)

print("\nâŒ ì˜ëª»ëœ ë°©ë²• (= ì‚¬ìš©):")
for src, dst in zip(row, col):
    out_wrong[dst] = x[src] * deg_inv[dst]  # = ì‚¬ìš© (ë®ì–´ì“°ê¸°!)
    print(f"  out[{dst}] = {out_wrong[dst].tolist()} (ë®ì–´ì”€)")

print(f"\nê²°ê³¼: out[3] = {out_wrong[3].tolist()}")
print(f"ë¬¸ì œ: ë§ˆì§€ë§‰ ì´ì›ƒ(ë…¸ë“œ 2)ì˜ ê°’ë§Œ ë‚¨ìŒ! ë…¸ë“œ 0, 1ì˜ ì •ë³´ ì†ì‹¤!")

print("\nâœ… ì˜¬ë°”ë¥¸ ë°©ë²• (+= ì‚¬ìš©):")
for src, dst in zip(row, col):
    out_correct[dst] += x[src] * deg_inv[dst]  # += ì‚¬ìš© (ëˆ„ì !)
    print(f"  out[{dst}] += ... â†’ {out_correct[dst].tolist()} (ëˆ„ì )")

print(f"\nê²°ê³¼: out[3] = {out_correct[3].tolist()}")
print(f"ì„±ê³µ: ëª¨ë“  ì´ì›ƒ(ë…¸ë“œ 0, 1, 2)ì˜ ì •ë³´ê°€ ë°˜ì˜ë¨!")

# ============================================================================
# í•µì‹¬ ì •ë¦¬
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ“ í•µì‹¬ ì •ë¦¬")
print("=" * 80)

print("""
out[dst] += x[src] * deg_inv[dst]

ê° ë¶€ë¶„ì˜ ì˜ë¯¸:

1. x[src]
   â†’ src ë…¸ë“œì˜ íŠ¹ì„± ë²¡í„°
   â†’ "ë³´ë‚¼ ë©”ì‹œì§€"

2. deg_inv[dst]
   â†’ dst ë…¸ë“œì˜ ì´ì›ƒ ìˆ˜ ì—­ìˆ˜ (1/ì´ì›ƒìˆ˜)
   â†’ "í‰ê·  ê³„ì‚°ì„ ìœ„í•œ ê°€ì¤‘ì¹˜"

3. *
   â†’ ë²¡í„°ì— ìŠ¤ì¹¼ë¼ ê³±ì…ˆ
   â†’ ê° ì°¨ì›ì— ë™ì¼í•œ ê°’ ê³±í•¨
   â†’ ì˜ˆ: [0.9, 0.1] * 0.5 = [0.45, 0.05]

4. out[dst] +=
   â†’ dst ë…¸ë“œì˜ ê¸°ì¡´ ê°’ì— ë”í•¨ (ëˆ„ì !)
   â†’ ì—¬ëŸ¬ ì´ì›ƒì˜ ì •ë³´ë¥¼ ëª¨ë‘ ëª¨ìœ¼ê¸° ìœ„í•¨

5. ìµœì¢… íš¨ê³¼
   â†’ ê° ë…¸ë“œëŠ” ì´ì›ƒë“¤ì˜ íŠ¹ì„±ì„ í‰ê· ë‚¸ ê°’ì„ ë°›ìŒ
   â†’ ê·¸ë˜í”„ êµ¬ì¡°ë¥¼ í™œìš©í•œ ì •ë³´ ì „íŒŒ!

ì‹¤ì œ ì˜ë¯¸:
    "ë‚˜ë¥¼ ì¸ìš©í•œ ë…¼ë¬¸ë“¤ì´ AI ë…¼ë¬¸ì´ë©´, ë‚˜ë„ AI ë…¼ë¬¸ì¼ ê°€ëŠ¥ì„± ë†’ë‹¤"
    "ë‚´ ì¹œêµ¬ë“¤ì´ ì¢‹ì•„í•˜ëŠ” ê²ƒì€, ë‚˜ë„ ì¢‹ì•„í•  ê°€ëŠ¥ì„± ë†’ë‹¤"
    â†’ ì´ì›ƒì˜ ì •ë³´ê°€ ë‚˜ì—ê²Œ ì˜í–¥ì„ ì¤Œ!
""")

print("=" * 80)
print("âœ… ì´í•´ê°€ ë˜ì…¨ë‚˜ìš”? test_aggregate.pyë„ ì‹¤í–‰í•´ë³´ì„¸ìš”!")
print("=" * 80)
